<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traafik - Driver-Officer Communication Demo</title>
    
    <!-- React and React DOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      body { 
        font-family: system-ui, -apple-system, sans-serif; 
        margin: 0;
        padding: 0;
      }
      .demo-panel {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        position: relative;
      }
      .driver-panel { 
        border-color: #3b82f6; 
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      }
      .officer-panel { 
        border-color: #10b981; 
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }
      .status-created { background-color: #fbbf24; }
      .status-assigned { background-color: #3b82f6; }
      .status-verified { background-color: #10b981; }
      .status-completed { background-color: #6b7280; }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .notification.show {
        transform: translateX(0);
      }
      
      .workflow-step {
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border-left: 4px solid #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        transition: all 0.3s ease;
      }
      
      .workflow-step.active {
        background: rgba(59, 130, 246, 0.2);
        transform: translateX(4px);
      }
      
      .workflow-step.completed {
        border-left-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { createRoot } = ReactDOM;

      // Mock API that simulates backend responses
      class MockApiClient {
        constructor() {
          this.users = new Map();
          this.sessions = new Map();
          this.currentUser = null;
          this.sessionCounter = 1;
        }

        async delay(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        async register(userData) {
          await this.delay(500); // Simulate network delay
          
          const user = {
            id: `user-${Date.now()}`,
            email: userData.email,
            role: userData.role,
            firstName: userData.firstName,
            lastName: userData.lastName,
            createdAt: new Date().toISOString()
          };
          
          this.users.set(userData.email, { ...user, password: userData.password });
          this.currentUser = user;
          
          return {
            user,
            accessToken: `mock-jwt-${Date.now()}`,
            tokenType: 'Bearer',
            expiresIn: 3600
          };
        }

        async login(credentials) {
          await this.delay(300);
          
          const user = this.users.get(credentials.email);
          if (!user || user.password !== credentials.password) {
            throw new Error('Invalid credentials');
          }
          
          this.currentUser = user;
          return {
            user: { ...user, password: undefined },
            accessToken: `mock-jwt-${Date.now()}`,
            tokenType: 'Bearer',
            expiresIn: 3600
          };
        }

        async createSession(sessionData) {
          await this.delay(400);
          
          const session = {
            id: `session-${this.sessionCounter++}`,
            status: 'CREATED',
            address: sessionData.address,
            reason: sessionData.reason,
            latitude: sessionData.latitude,
            longitude: sessionData.longitude,
            driverName: `${this.currentUser.firstName} ${this.currentUser.lastName}`,
            officerName: null,
            createdAt: new Date().toISOString(),
            startedAt: new Date().toISOString()
          };
          
          this.sessions.set(session.id, session);
          return session;
        }

        async getMySessions() {
          await this.delay(200);
          return {
            content: Array.from(this.sessions.values()),
            totalElements: this.sessions.size
          };
        }

        async getActiveSessions() {
          await this.delay(200);
          const activeSessions = Array.from(this.sessions.values())
            .filter(s => ['CREATED', 'ASSIGNED', 'VERIFIED'].includes(s.status));
          
          return {
            content: activeSessions,
            totalElements: activeSessions.length
          };
        }

        async assignToSession(sessionId) {
          await this.delay(600);
          
          const session = this.sessions.get(sessionId);
          if (!session) throw new Error('Session not found');
          
          session.status = 'ASSIGNED';
          session.officerName = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
          session.assignedAt = new Date().toISOString();
          
          return session;
        }

        async updateSessionStatus(sessionId, statusData) {
          await this.delay(500);
          
          const session = this.sessions.get(sessionId);
          if (!session) throw new Error('Session not found');
          
          session.status = statusData.status;
          session.notes = statusData.reason;
          
          if (statusData.status === 'VERIFIED') {
            session.verifiedAt = new Date().toISOString();
          } else if (statusData.status === 'COMPLETED') {
            session.completedAt = new Date().toISOString();
          }
          
          return session;
        }
      }

      const mockApi = new MockApiClient();

      // Notification Component
      function Notification({ message, show, onClose }) {
        useEffect(() => {
          if (show) {
            const timer = setTimeout(onClose, 3000);
            return () => clearTimeout(timer);
          }
        }, [show, onClose]);

        return (
          <div className={`notification ${show ? 'show' : ''}`}>
            {message}
          </div>
        );
      }

      // Demo Application
      function DemoApp() {
        const [driverUser, setDriverUser] = useState(null);
        const [officerUser, setOfficerUser] = useState(null);
        const [currentSession, setCurrentSession] = useState(null);
        const [sessions, setSessions] = useState([]);
        const [activeSessions, setActiveSessions] = useState([]);
        const [logs, setLogs] = useState([]);
        const [notification, setNotification] = useState({ show: false, message: '' });
        const [workflowStep, setWorkflowStep] = useState(0);

        const workflowSteps = [
          "üöó Driver initiates traffic stop session",
          "üì° Location shared with dispatch center",
          "üëÆ‚Äç‚ôÄÔ∏è Officer receives and accepts assignment",
          "üîç Officer verifies driver credentials",
          "üìã Session completed and documented"
        ];

        const showNotification = (message) => {
          setNotification({ show: true, message });
        };

        const hideNotification = () => {
          setNotification({ show: false, message: '' });
        };

        const addLog = (message, type = 'info') => {
          const timestamp = new Date().toLocaleTimeString();
          setLogs(prev => [...prev.slice(-10), { timestamp, message, type }]); // Keep last 10 logs
        };

        // Initialize demo users
        useEffect(() => {
          initializeDemoUsers();
        }, []);

        const initializeDemoUsers = async () => {
          try {
            addLog('üöÄ Initializing demo users...', 'info');
            
            // Register driver user
            const driverData = {
              email: 'john.driver@traafik.com',
              password: 'demo123',
              firstName: 'John',
              lastName: 'Driver',
              role: 'DRIVER'
            };
            
            const officerData = {
              email: 'jane.officer@traafik.com',
              password: 'demo123',
              firstName: 'Officer Jane',
              lastName: 'Smith',
              role: 'OFFICER'
            };

            const driverResponse = await mockApi.register(driverData);
            setDriverUser(driverResponse.user);
            addLog('‚úÖ Driver registered and authenticated', 'success');

            // Switch to officer context
            const officerResponse = await mockApi.register(officerData);
            setOfficerUser(officerResponse.user);
            addLog('‚úÖ Officer registered and authenticated', 'success');
            
            showNotification('Demo users initialized successfully!');

          } catch (error) {
            addLog(`‚ùå Failed to initialize users: ${error.message}`, 'error');
          }
        };

        const createTrafficSession = async () => {
          try {
            // Switch to driver context
            await mockApi.login({
              email: 'john.driver@traafik.com',
              password: 'demo123'
            });

            addLog('üöó Driver creating traffic stop session...', 'info');
            setWorkflowStep(1);
            
            const sessionData = {
              address: '123 Main Street, Downtown City, CA 90210',
              reason: 'Routine traffic stop - speeding violation',
              latitude: 40.7128,
              longitude: -74.0060
            };

            const session = await mockApi.createSession(sessionData);
            setCurrentSession(session);
            addLog(`‚úÖ Session created: ${session.id}`, 'success');
            addLog('üìç GPS location shared with dispatch', 'info');
            setWorkflowStep(2);
            
            // Refresh sessions list
            refreshSessions();
            showNotification('Traffic stop session created!');
            
          } catch (error) {
            addLog(`‚ùå Failed to create session: ${error.message}`, 'error');
          }
        };

        const officerAssignToSession = async (sessionId) => {
          try {
            // Switch to officer context
            await mockApi.login({
              email: 'jane.officer@traafik.com',
              password: 'demo123'
            });

            addLog('üëÆ‚Äç‚ôÄÔ∏è Officer responding to session...', 'info');
            setWorkflowStep(3);
            
            const updatedSession = await mockApi.assignToSession(sessionId);
            setCurrentSession(updatedSession);
            addLog(`‚úÖ Officer Smith assigned to session ${sessionId}`, 'success');
            addLog('üì± Driver notified of officer assignment', 'info');
            
            refreshSessions();
            showNotification('Officer assigned to traffic stop!');
            
          } catch (error) {
            addLog(`‚ùå Failed to assign officer: ${error.message}`, 'error');
          }
        };

        const updateSessionStatus = async (sessionId, status, reason = '') => {
          try {
            addLog(`üîÑ Updating session status to ${status}...`, 'info');
            
            const statusData = { status, reason };
            const updatedSession = await mockApi.updateSessionStatus(sessionId, statusData);
            setCurrentSession(updatedSession);
            
            if (status === 'VERIFIED') {
              addLog(`‚úÖ Driver credentials verified`, 'success');
              addLog('üîí Secure communication channel established', 'info');
              setWorkflowStep(4);
              showNotification('Driver verification completed!');
            } else if (status === 'COMPLETED') {
              addLog(`üèÅ Session completed successfully`, 'success');
              addLog('üìä Incident report generated automatically', 'info');
              setWorkflowStep(5);
              showNotification('Traffic stop completed successfully!');
            }
            
            refreshSessions();
            
          } catch (error) {
            addLog(`‚ùå Failed to update status: ${error.message}`, 'error');
          }
        };

        const refreshSessions = async () => {
          try {
            const [mySessions, activeSessionsList] = await Promise.all([
              mockApi.getMySessions(),
              mockApi.getActiveSessions()
            ]);
            
            setSessions(mySessions.content || []);
            setActiveSessions(activeSessionsList.content || []);
            
          } catch (error) {
            console.error('Failed to refresh sessions:', error);
          }
        };

        const getStatusColor = (status) => {
          switch (status) {
            case 'CREATED': return 'status-created';
            case 'ASSIGNED': return 'status-assigned';
            case 'VERIFIED': return 'status-verified';
            case 'COMPLETED': return 'status-completed';
            default: return 'status-created';
          }
        };

        const resetDemo = () => {
          setCurrentSession(null);
          setSessions([]);
          setActiveSessions([]);
          setLogs([]);
          setWorkflowStep(0);
          mockApi.sessions.clear();
          showNotification('Demo reset successfully!');
        };

        const clearLogs = () => setLogs([]);

        return (
          <div className="min-h-screen bg-gray-50 p-4">
            <Notification 
              message={notification.message} 
              show={notification.show} 
              onClose={hideNotification} 
            />
            
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-gray-900 mb-2">
                  üöì Traafik Driver-Officer Communication Demo
                </h1>
                <p className="text-gray-600 text-lg">
                  Experience secure, real-time traffic stop management workflow
                </p>
                <div className="mt-4 inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                  <span className="status-indicator bg-green-500"></span>
                  Demo Mode - Mock API Active
                </div>
              </div>

              {/* Workflow Progress */}
              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 className="text-xl font-semibold mb-4">üîÑ Workflow Progress</h2>
                <div className="space-y-2">
                  {workflowSteps.map((step, index) => (
                    <div
                      key={index}
                      className={`workflow-step ${
                        index < workflowStep ? 'completed' : 
                        index === workflowStep ? 'active' : ''
                      }`}
                    >
                      {step}
                    </div>
                  ))}
                </div>
              </div>

              {/* Demo Controls */}
              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 className="text-xl font-semibold mb-4">üéÆ Demo Controls</h2>
                <div className="flex flex-wrap gap-4">
                  <button
                    onClick={createTrafficSession}
                    className="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
                    disabled={!driverUser}
                  >
                    üöó Step 1: Driver Creates Session
                  </button>
                  
                  <button
                    onClick={() => currentSession && officerAssignToSession(currentSession.id)}
                    className="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-medium"
                    disabled={!officerUser || !currentSession || currentSession.status !== 'CREATED'}
                  >
                    üëÆ‚Äç‚ôÄÔ∏è Step 2: Officer Responds
                  </button>
                  
                  <button
                    onClick={() => currentSession && updateSessionStatus(currentSession.id, 'VERIFIED', 'Driver credentials verified - License valid, no warrants')}
                    className="px-6 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-medium"
                    disabled={!currentSession || currentSession.status !== 'ASSIGNED'}
                  >
                    ‚úÖ Step 3: Verify Driver
                  </button>
                  
                  <button
                    onClick={() => currentSession && updateSessionStatus(currentSession.id, 'COMPLETED', 'Traffic stop completed - Warning issued, no citation')}
                    className="px-6 py-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-medium"
                    disabled={!currentSession || !['VERIFIED', 'REASONS_SELECTED'].includes(currentSession.status)}
                  >
                    üèÅ Step 4: Complete Session
                  </button>
                  
                  <button
                    onClick={resetDemo}
                    className="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-medium"
                  >
                    üîÑ Reset Demo
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Driver Panel */}
                <div className="demo-panel driver-panel">
                  <h3 className="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                    üöó Driver Interface
                    {currentSession && (
                      <span className="ml-2 text-sm bg-white px-2 py-1 rounded text-blue-600">
                        Session Active
                      </span>
                    )}
                  </h3>
                  
                  {driverUser ? (
                    <div className="space-y-4">
                      <div className="bg-white p-4 rounded-md shadow-sm">
                        <div className="text-sm">
                          <strong>Driver:</strong> {driverUser.firstName} {driverUser.lastName}
                        </div>
                        <div className="text-sm text-gray-600">
                          {driverUser.email}
                        </div>
                      </div>
                      
                      {currentSession && (
                        <div className="bg-white p-4 rounded-md shadow-sm border-l-4 border-blue-500">
                          <h4 className="font-medium mb-2">üö® Current Traffic Stop</h4>
                          <div className="text-sm space-y-2">
                            <div className="flex items-center">
                              <span className={`status-indicator ${getStatusColor(currentSession.status)}`}></span>
                              <strong>Status:</strong> <span className="ml-2">{currentSession.status}</span>
                            </div>
                            <div><strong>Location:</strong> {currentSession.address}</div>
                            <div><strong>Reason:</strong> {currentSession.reason}</div>
                            <div><strong>Session ID:</strong> {currentSession.id}</div>
                            {currentSession.officerName && (
                              <div><strong>Assigned Officer:</strong> {currentSession.officerName}</div>
                            )}
                            {currentSession.notes && (
                              <div><strong>Notes:</strong> {currentSession.notes}</div>
                            )}
                          </div>
                        </div>
                      )}

                      <div className="bg-white p-4 rounded-md shadow-sm">
                        <h4 className="font-medium mb-2">üîí Security Features</h4>
                        <div className="text-sm space-y-1 text-gray-700">
                          <div>‚úì Encrypted location sharing</div>
                          <div>‚úì Identity verification via QR code</div>
                          <div>‚úì Real-time officer communication</div>
                          <div>‚úì Digital citation delivery</div>
                          <div>‚úì Secure payment processing</div>
                          <div>‚úì Automatic incident recording</div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="text-gray-500">Initializing driver interface...</div>
                  )}
                </div>

                {/* Officer Panel */}
                <div className="demo-panel officer-panel">
                  <h3 className="text-lg font-semibold text-green-800 mb-4 flex items-center">
                    üëÆ‚Äç‚ôÄÔ∏è Officer Interface
                    {activeSessions.length > 0 && (
                      <span className="ml-2 text-sm bg-white px-2 py-1 rounded text-green-600">
                        {activeSessions.length} Active
                      </span>
                    )}
                  </h3>
                  
                  {officerUser ? (
                    <div className="space-y-4">
                      <div className="bg-white p-4 rounded-md shadow-sm">
                        <div className="text-sm">
                          <strong>Officer:</strong> {officerUser.firstName} {officerUser.lastName}
                        </div>
                        <div className="text-sm text-gray-600">
                          Badge #2847 | {officerUser.email}
                        </div>
                      </div>
                      
                      {activeSessions.length > 0 ? (
                        <div className="bg-white p-4 rounded-md shadow-sm border-l-4 border-green-500">
                          <h4 className="font-medium mb-2">üìã Available Assignments</h4>
                          {activeSessions.map(session => (
                            <div key={session.id} className="text-sm border-b py-2 last:border-b-0">
                              <div className="flex items-center justify-between">
                                <div>
                                  <span className={`status-indicator ${getStatusColor(session.status)}`}></span>
                                  {session.address}
                                </div>
                                <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">
                                  {session.status}
                                </span>
                              </div>
                              <div className="text-gray-600 mt-1">{session.reason}</div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="bg-white p-4 rounded-md shadow-sm text-center text-gray-500">
                          No active sessions requiring attention
                        </div>
                      )}

                      <div className="bg-white p-4 rounded-md shadow-sm">
                        <h4 className="font-medium mb-2">‚ö° Officer Tools</h4>
                        <div className="text-sm space-y-1 text-gray-700">
                          <div>‚úì Real-time dispatch notifications</div>
                          <div>‚úì Driver credential verification</div>
                          <div>‚úì Digital citation issuance</div>
                          <div>‚úì Body cam integration</div>
                          <div>‚úì Backup officer alerts</div>
                          <div>‚úì Automatic incident reports</div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="text-gray-500">Initializing officer interface...</div>
                  )}
                </div>
              </div>

              {/* Activity Log */}
              <div className="mt-6 bg-white rounded-lg shadow-md p-6">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">üìã Real-time Activity Log</h3>
                  <button
                    onClick={clearLogs}
                    className="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors"
                  >
                    Clear
                  </button>
                </div>
                <div className="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm max-h-64 overflow-y-auto">
                  {logs.length === 0 ? (
                    <div className="text-gray-500">System ready. Waiting for user activity...</div>
                  ) : (
                    logs.map((log, index) => (
                      <div key={index} className={`mb-1 ${
                        log.type === 'error' ? 'text-red-400' : 
                        log.type === 'success' ? 'text-green-400' : 
                        'text-blue-400'
                      }`}>
                        <span className="text-gray-500">[{log.timestamp}]</span> {log.message}
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* System Status */}
              <div className="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 className="text-lg font-semibold mb-4">üîß System Status</h3>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                  <div className="flex items-center">
                    <span className="status-indicator bg-green-500"></span>
                    <span><strong>API:</strong> Mock Active</span>
                  </div>
                  <div className="flex items-center">
                    <span className="status-indicator bg-green-500"></span>
                    <span><strong>Auth:</strong> JWT Simulated</span>
                  </div>
                  <div className="flex items-center">
                    <span className="status-indicator bg-green-500"></span>
                    <span><strong>Database:</strong> In-Memory</span>
                  </div>
                  <div className="flex items-center">
                    <span className="status-indicator bg-green-500"></span>
                    <span><strong>Security:</strong> Encrypted</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Render the app
      createRoot(document.getElementById('root')).render(<DemoApp />);
    </script>
  </body>
</html>