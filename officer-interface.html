<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traafik - Officer Interface</title>
    
    <!-- React and React DOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      body { 
        font-family: system-ui, -apple-system, sans-serif; 
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      
      .chat-message {
        animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }
      
      .status-connected { background-color: #10b981; }
      .status-waiting { background-color: #f59e0b; }
      .status-offline { background-color: #ef4444; }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .notification.show {
        transform: translateX(0);
      }
      
      .driver-card {
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .driver-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }
      
      .map-placeholder {
        background: linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%),
                    linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { createRoot } = ReactDOM;

      // Shared storage for communication between driver and officer
      const SharedStorage = {
        setItem: (key, value) => {
          localStorage.setItem(`traafik_${key}`, JSON.stringify({
            data: value,
            timestamp: Date.now()
          }));
          window.dispatchEvent(new StorageEvent('storage', {
            key: `traafik_${key}`,
            newValue: JSON.stringify({ data: value, timestamp: Date.now() })
          }));
        },
        
        getItem: (key) => {
          const item = localStorage.getItem(`traafik_${key}`);
          return item ? JSON.parse(item).data : null;
        },
        
        subscribe: (key, callback) => {
          const handleStorage = (e) => {
            if (e.key === `traafik_${key}` && e.newValue) {
              const parsed = JSON.parse(e.newValue);
              callback(parsed.data);
            }
          };
          window.addEventListener('storage', handleStorage);
          return () => window.removeEventListener('storage', handleStorage);
        }
      };

      // Notification Component
      function Notification({ message, show, onClose, type = 'info' }) {
        useEffect(() => {
          if (show) {
            const timer = setTimeout(onClose, 4000);
            return () => clearTimeout(timer);
          }
        }, [show, onClose]);

        const bgColor = type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#10b981';

        return (
          <div 
            className={`notification ${show ? 'show' : ''}`}
            style={{ backgroundColor: bgColor }}
          >
            {message}
          </div>
        );
      }

      // Officer Application
      function OfficerApp() {
        const [isLoggedIn, setIsLoggedIn] = useState(false);
        const [email, setEmail] = useState('');
        const [officerName, setOfficerName] = useState('');
        const [badgeNumber, setBadgeNumber] = useState('');
        const [availableDrivers, setAvailableDrivers] = useState([]);
        const [connectedDriver, setConnectedDriver] = useState(null);
        const [messages, setMessages] = useState([]);
        const [currentMessage, setCurrentMessage] = useState('');
        const [notification, setNotification] = useState({ show: false, message: '', type: 'info' });
        const [citationForm, setCitationForm] = useState({
          violation: '',
          amount: '',
          notes: ''
        });
        const [showCitationForm, setShowCitationForm] = useState(false);
        const messagesEndRef = useRef(null);

        const showNotification = (message, type = 'info') => {
          setNotification({ show: true, message, type });
        };

        const hideNotification = () => {
          setNotification({ show: false, message: '', type: 'info' });
        };

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        useEffect(() => {
          scrollToBottom();
        }, [messages]);

        // Listen for driver sessions and messages
        useEffect(() => {
          const unsubscribeDrivers = SharedStorage.subscribe('driver_session', (data) => {
            setAvailableDrivers(prev => {
              const existing = prev.find(d => d.driverEmail === data.driverEmail);
              if (existing) {
                return prev.map(d => d.driverEmail === data.driverEmail ? data : d);
              } else {
                return [...prev, data];
              }
            });
            showNotification(`New driver session: ${data.driverName} requesting assistance`);
          });

          const unsubscribeMessages = SharedStorage.subscribe('driver_messages', (data) => {
            if (connectedDriver && data.driverEmail === connectedDriver.driverEmail) {
              setMessages(prev => [...prev, {
                id: Date.now(),
                text: data.message,
                sender: 'driver',
                timestamp: new Date(data.timestamp).toLocaleTimeString(),
                senderName: data.driverName
              }]);
            }
          });

          const unsubscribePayment = SharedStorage.subscribe('payment_completed', (data) => {
            if (connectedDriver && data.driverEmail === connectedDriver.driverEmail) {
              showNotification('Driver has paid the citation successfully!');
            }
          });

          const unsubscribeSessionEnd = SharedStorage.subscribe('session_ended', (data) => {
            if (connectedDriver && data.driverEmail === connectedDriver.driverEmail) {
              setConnectedDriver(null);
              setMessages([]);
              showNotification('Driver ended the session');
            }
          });

          return () => {
            unsubscribeDrivers();
            unsubscribeMessages();
            unsubscribePayment();
            unsubscribeSessionEnd();
          };
        }, [connectedDriver]);

        const handleLogin = (e) => {
          e.preventDefault();
          if (email.includes('@')) {
            const name = `Officer ${email.split('@')[0].toUpperCase()}`;
            const badge = Math.floor(Math.random() * 9000) + 1000; // Random badge number
            setOfficerName(name);
            setBadgeNumber(badge.toString());
            setIsLoggedIn(true);
            showNotification(`Welcome ${name}! Badge #${badge}`);
          } else {
            showNotification('Please enter a valid email address', 'error');
          }
        };

        const connectToDriver = (driver) => {
          setConnectedDriver(driver);
          
          // Notify driver of connection
          SharedStorage.setItem('officer_connection', {
            driverEmail: driver.driverEmail,
            officer: {
              name: officerName,
              badge: badgeNumber,
              email: email
            },
            timestamp: Date.now()
          });

          showNotification(`Connected to ${driver.driverName}`);
        };

        const sendMessage = () => {
          if (!currentMessage.trim() || !connectedDriver) return;

          const message = {
            id: Date.now(),
            text: currentMessage,
            sender: 'officer',
            timestamp: new Date().toLocaleTimeString(),
            senderName: officerName
          };

          setMessages(prev => [...prev, message]);

          // Send to driver
          SharedStorage.setItem('officer_messages', {
            driverEmail: connectedDriver.driverEmail,
            message: currentMessage,
            officerName: officerName,
            timestamp: Date.now()
          });

          setCurrentMessage('');
        };

        const issueCitation = () => {
          if (!citationForm.violation || !citationForm.amount || !connectedDriver) {
            showNotification('Please fill in all citation fields', 'error');
            return;
          }

          const citation = {
            number: `TC-${Date.now()}`,
            violation: citationForm.violation,
            amount: parseFloat(citationForm.amount),
            notes: citationForm.notes,
            issuedBy: officerName,
            badgeNumber: badgeNumber,
            issuedAt: new Date().toISOString(),
            dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(), // 30 days from now
            status: 'unpaid'
          };

          // Send citation to driver
          SharedStorage.setItem('citation_issued', {
            driverEmail: connectedDriver.driverEmail,
            citation: citation,
            timestamp: Date.now()
          });

          setCitationForm({ violation: '', amount: '', notes: '' });
          setShowCitationForm(false);
          showNotification(`Citation ${citation.number} issued to ${connectedDriver.driverName}`);
        };

        const calculateDistance = (lat1, lng1, lat2, lng2) => {
          const R = 3959; // Earth's radius in miles
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLng = (lng2 - lng1) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return (R * c).toFixed(1);
        };

        if (!isLoggedIn) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4">
              <Notification 
                message={notification.message} 
                show={notification.show} 
                onClose={hideNotification}
                type={notification.type}
              />
              
              <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <div className="text-center mb-6">
                  <div className="w-16 h-16 bg-green-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span className="text-white text-2xl">👮‍♀️</span>
                  </div>
                  <h1 className="text-2xl font-bold text-gray-900">Officer Login</h1>
                  <p className="text-gray-600">Traafik Traffic Stop System</p>
                </div>
                
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Officer Email Address
                    </label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="officer@police.gov"
                      required
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                    />
                  </div>
                  
                  <button
                    type="submit"
                    className="w-full bg-green-600 text-white p-3 rounded-md font-medium hover:bg-green-700 transition-colors"
                  >
                    Login as Officer
                  </button>
                </form>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gray-50">
            <Notification 
              message={notification.message} 
              show={notification.show} 
              onClose={hideNotification}
              type={notification.type}
            />
            
            {/* Header */}
            <div className="bg-white shadow-sm border-b">
              <div className="max-w-6xl mx-auto px-4 py-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                      <span className="text-white text-lg">👮‍♀️</span>
                    </div>
                    <div>
                      <h1 className="text-xl font-semibold text-gray-900">Officer Interface</h1>
                      <p className="text-sm text-gray-600">{officerName} • Badge #{badgeNumber} • {email}</p>
                    </div>
                  </div>
                  
                  <div className="flex items-center space-x-4">
                    <div className="flex items-center">
                      <span className={`status-indicator ${connectedDriver ? 'status-connected' : availableDrivers.length > 0 ? 'status-waiting' : 'status-offline'}`}></span>
                      <span className="text-sm text-gray-600">
                        {connectedDriver ? 'Connected to Driver' : availableDrivers.length > 0 ? `${availableDrivers.length} Available` : 'No Active Sessions'}
                      </span>
                    </div>
                    
                    <button
                      onClick={() => {
                        setIsLoggedIn(false);
                        setConnectedDriver(null);
                        setMessages([]);
                        setAvailableDrivers([]);
                      }}
                      className="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                    >
                      Logout
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div className="max-w-6xl mx-auto p-4">
              {!connectedDriver ? (
                /* Available Drivers */
                <div className="bg-white rounded-lg shadow-md p-6">
                  <h2 className="text-lg font-semibold mb-4 text-gray-900">Available Traffic Stop Sessions</h2>
                  
                  {availableDrivers.length === 0 ? (
                    <div className="text-center text-gray-500 py-8">
                      <div className="text-4xl mb-4">🚓</div>
                      <p>No active traffic stop sessions</p>
                      <p className="text-sm">Waiting for drivers to initiate sessions...</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {availableDrivers.map((driver, index) => (
                        <div
                          key={index}
                          className="driver-card bg-gray-50 border border-gray-200 rounded-lg p-4"
                          onClick={() => connectToDriver(driver)}
                        >
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="font-medium text-gray-900">{driver.driverName}</h3>
                            <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                              WAITING
                            </span>
                          </div>
                          
                          <div className="text-sm text-gray-600 space-y-1">
                            <div><strong>Email:</strong> {driver.driverEmail}</div>
                            <div><strong>Location:</strong> {driver.location.lat}, {driver.location.lng}</div>
                            <div><strong>Time:</strong> {new Date(driver.timestamp).toLocaleTimeString()}</div>
                          </div>
                          
                          <div className="mt-3 pt-3 border-t border-gray-200">
                            <button
                              className="w-full bg-green-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-green-700 transition-colors"
                              onClick={(e) => {
                                e.stopPropagation();
                                connectToDriver(driver);
                              }}
                            >
                              🚨 Respond to Call
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ) : (
                /* Connected Driver Interface */
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Driver Information & Map */}
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                      <h2 className="text-lg font-semibold mb-4 text-gray-900">Connected Driver</h2>
                      
                      <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                        <div className="space-y-2 text-sm">
                          <div><strong>Driver:</strong> {connectedDriver.driverName}</div>
                          <div><strong>Email:</strong> {connectedDriver.driverEmail}</div>
                          <div><strong>Location:</strong> {connectedDriver.location.lat}, {connectedDriver.location.lng}</div>
                          <div><strong>Session Started:</strong> {new Date(connectedDriver.timestamp).toLocaleString()}</div>
                        </div>
                      </div>
                      
                      <div className="flex space-x-3">
                        <button
                          onClick={() => setShowCitationForm(!showCitationForm)}
                          className="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors"
                        >
                          📋 Issue Citation
                        </button>
                        
                        <button
                          onClick={() => {
                            setConnectedDriver(null);
                            setMessages([]);
                            showNotification('Disconnected from driver');
                          }}
                          className="bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-700 transition-colors"
                        >
                          End Session
                        </button>
                      </div>
                    </div>

                    {/* Location Map Placeholder */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                      <h3 className="text-lg font-semibold mb-4 text-gray-900">Driver Location</h3>
                      <div className="map-placeholder h-64 rounded-md flex items-center justify-center border border-gray-200">
                        <div className="text-center">
                          <div className="text-4xl mb-2">📍</div>
                          <div className="text-sm text-gray-600">
                            <div>Lat: {connectedDriver.location.lat}</div>
                            <div>Lng: {connectedDriver.location.lng}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Communication Panel */}
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-lg font-semibold mb-4 text-gray-900">Communication</h2>
                    
                    {/* Messages */}
                    <div className="border rounded-md p-4 h-64 overflow-y-auto bg-gray-50 mb-4">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 py-8">
                          Start a conversation with the driver.
                        </div>
                      ) : (
                        messages.map((msg) => (
                          <div key={msg.id} className={`chat-message mb-3 ${msg.sender === 'officer' ? 'text-right' : 'text-left'}`}>
                            <div className={`inline-block max-w-xs px-3 py-2 rounded-lg ${
                              msg.sender === 'officer' 
                                ? 'bg-green-600 text-white' 
                                : 'bg-white border border-gray-200'
                            }`}>
                              <div className="text-sm">{msg.text}</div>
                              <div className={`text-xs mt-1 ${msg.sender === 'officer' ? 'text-green-100' : 'text-gray-500'}`}>
                                {msg.senderName} • {msg.timestamp}
                              </div>
                            </div>
                          </div>
                        ))
                      )}
                      <div ref={messagesEndRef} />
                    </div>
                    
                    {/* Message Input */}
                    <div className="flex space-x-2">
                      <input
                        type="text"
                        value={currentMessage}
                        onChange={(e) => setCurrentMessage(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder="Type your message..."
                        className="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                      />
                      <button
                        onClick={sendMessage}
                        disabled={!currentMessage.trim()}
                        className="px-6 py-3 bg-green-600 text-white rounded-md font-medium hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                      >
                        Send
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Citation Form */}
              {showCitationForm && connectedDriver && (
                <div className="mt-6 bg-white rounded-lg shadow-md p-6">
                  <h2 className="text-lg font-semibold mb-4 text-gray-900">Issue Citation</h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Violation Type
                      </label>
                      <select
                        value={citationForm.violation}
                        onChange={(e) => setCitationForm({...citationForm, violation: e.target.value, amount: e.target.selectedOptions[0].dataset.amount || ''})}
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                      >
                        <option value="">Select violation...</option>
                        <option value="Speeding (1-10 mph over)" data-amount="150">Speeding (1-10 mph over)</option>
                        <option value="Speeding (11-20 mph over)" data-amount="250">Speeding (11-20 mph over)</option>
                        <option value="Speeding (21+ mph over)" data-amount="350">Speeding (21+ mph over)</option>
                        <option value="Running Red Light" data-amount="300">Running Red Light</option>
                        <option value="Running Stop Sign" data-amount="250">Running Stop Sign</option>
                        <option value="Illegal Parking" data-amount="75">Illegal Parking</option>
                        <option value="Phone Use While Driving" data-amount="200">Phone Use While Driving</option>
                        <option value="Seatbelt Violation" data-amount="100">Seatbelt Violation</option>
                        <option value="Other" data-amount="200">Other</option>
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Fine Amount ($)
                      </label>
                      <input
                        type="number"
                        value={citationForm.amount}
                        onChange={(e) => setCitationForm({...citationForm, amount: e.target.value})}
                        placeholder="0.00"
                        min="0"
                        step="0.01"
                        className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                      />
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Additional Notes
                    </label>
                    <textarea
                      value={citationForm.notes}
                      onChange={(e) => setCitationForm({...citationForm, notes: e.target.value})}
                      placeholder="Additional details about the violation..."
                      rows={3}
                      className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                    />
                  </div>
                  
                  <div className="flex space-x-4">
                    <button
                      onClick={issueCitation}
                      className="bg-red-600 text-white px-6 py-3 rounded-md font-medium hover:bg-red-700 transition-colors"
                    >
                      📋 Issue Citation
                    </button>
                    
                    <button
                      onClick={() => setShowCitationForm(false)}
                      className="bg-gray-600 text-white px-6 py-3 rounded-md font-medium hover:bg-gray-700 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Render the app
      createRoot(document.getElementById('root')).render(<OfficerApp />);
    </script>
  </body>
</html>